# Android渗透06：软件保护之代码混淆

## 0x00 前言

**为什么要了解代码混淆技术？**

对于移动应用来说，代码安全非常重要，如果 App 的代码被攻击者逆向，就可以分析代码的执行逻辑，进一步可以对关键的位置进行 Hook、破解、二次打包等操作，进而引发安全问题。开发者一般都会对发布的应用代码进行保护，代码混淆就属于代码保护技术的一种。接下来，我们分享安卓应用代码混淆相关的内容。

**本文解决的问题：**

+ 什么是代码混淆？
+ 代码混淆的原理是什么？
+ 如何对安卓应用进行混淆？

## 0x01 代码混淆概念

**代码混淆的原理是什么？**

代码混淆（Obfuscation）是将电脑程序的原始代码或机器代码，转换成功能上等价，但是难于被人阅读和理解的行为。混淆后的代码，会将原先有明确含义的类名、字段、函数等转为无意义的单词，这样对于计算机来说，执行逻辑还是正常的，但是当人们去分析混淆后的代码时，会加大阅读和理解的难度，以此来加强代码的保护。

**代码混淆主要的工作：**

+ 将代码中的各种元素，比如变量、函数、类的名字改成无意义的名字，使得阅读时无法根据名字猜测其用途
+ 重写代码中的部分逻辑，将它们变为功能上等价、但是更难理解的形式，比如将循环改为递归、精简中间变量等
+ 打乱代码的格式，比如删除空格，将多行代码挤到一行代码等
+ 添加花指令，通过特殊构造的指令来使得反汇编器出错，进而干扰反编译的工作

**代码混淆有哪些缺点？**

代码混淆也存在一些问题，主要有：

+ 被混淆的代码难于理解，调试起来很困难，开发人员一般会保留原始的代码用于自己调试
+ 对于支持反射的语言，代码混淆有可能与反射发生冲突
+ 代码混淆并不能真正防止逆向工程，只能增加难度，对于安全性要求很高的场景，仅使用代码混淆并不能保证原始代码的安全

## 0x02 安卓代码混淆工具

**ProGuard工具**

ProGuard 是一个开源项目，官网 https://www.guardsquare.com/proguard ，同时也被集成到了Android SDK中，它的使用非常简单方便，Proguard 是使用 Java 编写专门用来对 Android 程序进行混淆的工具。

ProGuard 工具主要包含以下4个功能：

+ 压缩（Shrink）：检测并移除代码中无用的类、字段、方法和特性（Attribute）
+ 优化（Optimize）：对字节码进行优化，移除无用的指令
+ 混淆（Obfuscate）：使用a,b,c,d 这样简短无意义的名称，对类、字段和方法进行重新命名
+ 预检（Preverify）：在 Java 平台上对处理后的代码进行预检，确保加载的 class 文件是可执行的

ProGuar由Shrink、Optimize、Obfuscate和Preverify四个步骤组成，每个步骤都是可选的，我们可以通过配置脚本来决定执行其中的哪几个步骤 

![1660110620864](20220810-Android%E6%B8%97%E9%80%8F06-%E8%BD%AF%E4%BB%B6%E4%BF%9D%E6%8A%A4%E4%B9%8B%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86.assets/1660110620864.png)

在 Android SDK 中我们可以在  `Android/Sdk/tools/proguard/bin/proguardgui.sh`  路径下找到 ProGuard工具：

![1660110805806](20220810-Android%E6%B8%97%E9%80%8F06-%E8%BD%AF%E4%BB%B6%E4%BF%9D%E6%8A%A4%E4%B9%8B%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86.assets/1660110805806.png)

在 Android Studio 中集成了 ProGuard，需要使用的时候，只需要修改 build.gradle 中的配置就可以，把 minifyEnabled 改为 true ，生成的 release 版本的 apk 就是混淆过的。

![1660111114668](20220810-Android%E6%B8%97%E9%80%8F06-%E8%BD%AF%E4%BB%B6%E4%BF%9D%E6%8A%A4%E4%B9%8B%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86.assets/1660111114668.png)

其中 minifyEnabled 配置表示是否启用混淆，proguardFiles 表示选定混淆的配置文件

## 0x03 混淆一个Apk

首先写一个简单的 App Demo 

![1660111519966](20220810-Android%E6%B8%97%E9%80%8F06-%E8%BD%AF%E4%BB%B6%E4%BF%9D%E6%8A%A4%E4%B9%8B%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86.assets/1660111519966.png)

根据前面提到的 ProGuard 的配置，将 build.gradle 中的 minifyEnabled 改为 true，然后生成一个 relase 版本的 apk 。然后对 apk 文件进行反编译，具体反编译的方法可以参考上一篇文章，可以看到反编译之后的源代码：

![1660111823329](20220810-Android%E6%B8%97%E9%80%8F06-%E8%BD%AF%E4%BB%B6%E4%BF%9D%E6%8A%A4%E4%B9%8B%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86.assets/1660111823329.png)

我们发现很多的类名、方法名以及变量的名字已经被混淆，变为无意义的单词，增加了阅读代码的难度。当然也有部分的类名、方法没有发生变化，这个主要看具体的配置规则。这里使用的是默认的配置规则 是proguard-android-optimize.txt，可以打开规则看一下：

```
cat  ~/Android/Sdk/tools/proguard/proguard-android-optimize.txt
```

![1660112095390](20220810-Android%E6%B8%97%E9%80%8F06-%E8%BD%AF%E4%BB%B6%E4%BF%9D%E6%8A%A4%E4%B9%8B%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86.assets/1660112095390.png)

这里的规则我们也可以自己配置，具体规则的含义不是本文讲述的重点，网上有非常详细的介绍，大家可以自行查找这些配置具体含义。



## 0x04 结语

本文我们分享了代码混淆的意义和原理，以及如何对安卓应用进行混淆。代码混淆增加了代码逆向的难度，但是也只是增强了难度，还是不能防止代码被逆向。











